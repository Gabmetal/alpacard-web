generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  CONSUMER
  STAFF
  OWNER
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  clerkId   String   @unique
  email     String   @unique
  role      Role     @default(CONSUMER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessesOwned    Business[]    @relation("Owner")
  staffAt           Business[]    @relation("Staff", fields: [staffAtIds], references: [id])
  staffAtIds        String[]      @db.ObjectId
  cards             Card[]
}

model Business {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  logo        String?
  ownerId     String   @db.ObjectId
  owner       User     @relation("Owner", fields: [ownerId], references: [id])
  
  staffIds    String[] @db.ObjectId
  staff       User[]   @relation("Staff", fields: [staffIds], references: [id])

  campaigns   Campaign[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Campaign {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  description     String
  stampsRequired  Int
  logo            String?
  isActive        Boolean  @default(true)
  
  businessId      String   @db.ObjectId
  business        Business @relation(fields: [businessId], references: [id])
  
  cards           Card[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Card {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  stamps      Int      @default(0)
  
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id])
  
  campaignId  String   @db.ObjectId
  campaign    Campaign @relation(fields: [campaignId], references: [id])
  
  transactions Transaction[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, campaignId])
}

enum TransactionType {
  EARN
  REDEEM
}

model Transaction {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  type        TransactionType
  amount      Int      // How many stamps added or redeemed
  
  cardId      String   @db.ObjectId
  card        Card     @relation(fields: [cardId], references: [id])
  
  staffId     String   @db.ObjectId // Who performed the action (must be staff/owner)
  
  createdAt   DateTime @default(now())
}
